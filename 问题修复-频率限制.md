# 问题修复：AI返回空响应

## 问题现象

用户报告在答题过程中，前面几十题（约45题）都正常工作，但之后AI开始返回空响应：

```
WARNING | AI请求失败，跳过题目 45: AI返回空响应
WARNING | AI请求失败，跳过题目 46: AI返回空响应
```

同时，通过网页界面直接使用豆包是正常的，只有通过API调用时才出现问题。

## 问题原因

通过调试发现，豆包API在短时间内收到大量请求后会触发**频率限制（Rate Limiting）**：

```json
{
  "event_type": 2005,
  "event_data": {
    "code": 710022004,
    "message": "rate limited"
  }
}
```

原代码存在以下问题：

1. **未处理错误事件**: 代码没有处理 `event_type: 2005`（错误事件），只是记录警告后返回空文本
2. **延迟不足**: 每题之间只等待3秒，对于连续大量请求来说不够
3. **错误后立即继续**: 遇到频率限制后立即处理下一题，导致持续触发限制

## 修复方案

### 1. 处理错误事件 (doubao_service.py)

添加了对 `event_type: 2005` 的处理：

```python
elif event_type == 2005:
    # 错误事件
    error_code = event_data.get("code")
    error_message = event_data.get("message", "未知错误")
    logger.error(f"豆包API返回错误: code={error_code}, message={error_message}")
    raise Exception(f"豆包API错误 [{error_code}]: {error_message}")
```

现在当豆包返回错误时，会抛出明确的异常而不是返回空响应。

### 2. 增加基础延迟 (controller.py)

将每题之间的等待时间从3秒增加到5秒：

```python
# 6. 等待5秒加载下一题（避免频率限制）
await asyncio.sleep(5.0)
```

### 3. 智能检测频率限制 (controller.py)

当检测到频率限制错误时，自动等待更长时间：

```python
except AIServiceError as e:
    error_msg = str(e)
    
    # 检测是否是频率限制错误
    if "rate limited" in error_msg or "710022004" in error_msg:
        self.append_log(f"检测到频率限制，等待10秒后继续...")
        logger.warning(f"检测到频率限制，等待10秒")
        await asyncio.sleep(10.0)
    
    # 点击下一题继续
    ...
```

## 使用建议

### 对于普通使用

系统已经自动处理频率限制，你只需要：

1. **正常启动答题**: 系统会自动在每题之间等待5秒
2. **注意日志提示**: 如果看到"检测到频率限制"，系统会自动等待10秒
3. **耐心等待**: 总答题时间会比之前稍长，但更稳定

### 对于大量题目（超过50题）

建议采用以下策略：

1. **分批答题**: 每批30-40题，批次之间休息2-3分钟
2. **增加延迟**: 如果仍然频繁遇到限制，可以修改代码增加延迟：
   ```python
   # 在 controller.py 中修改
   await asyncio.sleep(8.0)  # 从5秒改为8秒
   ```

### 对于开发者

如果需要进一步优化，可以考虑：

1. **动态调整延迟**: 根据错误频率自动调整等待时间
2. **指数退避**: 连续遇到限制时，逐步增加等待时间
3. **请求队列**: 实现请求队列和速率控制

## 测试结果

修复后的行为：

```
✅ 正确识别频率限制错误
✅ 返回明确的错误信息而不是空响应
✅ 自动等待10秒后继续
✅ 基础延迟增加到5秒，降低触发概率
```

## 相关文件

- `DoubaoFreeApi/src/service/doubao_service.py` - 添加错误事件处理
- `DoubaoFreeApi/src/auto_answer/core/controller.py` - 增加延迟和智能检测
- `DoubaoFreeApi/频率限制说明.md` - 详细说明文档

## 注意事项

1. **频率限制是豆包服务器的保护机制**，无法完全绕过
2. **网页版也有限制**，只是表现形式不同（可能显示"请稍后再试"）
3. **等待时间是必要的**，不建议设置太短，否则可能导致账号被临时封禁
4. **使用登录模式**（session.json配置）比游客模式有更高的限额

## 后续优化方向

1. 添加重试机制：遇到频率限制时自动重试当前题目
2. 添加统计功能：记录成功率和平均响应时间
3. 添加暂停/恢复功能：允许用户手动暂停等待限制解除
4. 添加配置选项：让用户可以在GUI中调整延迟时间

---

**修复日期**: 2026-01-30  
**修复版本**: v1.1  
**问题编号**: #21
