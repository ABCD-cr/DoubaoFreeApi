# 豆包API频率限制说明

## 问题描述

在使用自动答题系统时，如果连续提问过多（通常在45题左右），豆包API会返回频率限制错误：

```
错误代码: 710022004
错误信息: rate limited
```

这是豆包服务器的保护机制，防止单个用户过度使用API资源。

## 解决方案

系统已经实现了以下机制来应对频率限制：

### 1. 基础延迟
每道题目完成后，系统会自动等待**5秒**再处理下一题，减少触发频率限制的可能性。

### 2. 智能检测
当检测到频率限制错误时，系统会：
- 自动等待**10秒**
- 跳过当前题目
- 继续处理下一题

### 3. 对话复用
系统会复用同一个对话ID，避免创建过多新对话导致的额外限制。

## 使用建议

1. **分批答题**: 如果题目很多（超过50题），建议分批进行，每批之间休息几分钟

2. **调整延迟**: 如果仍然频繁遇到限制，可以在配置中增加延迟时间：
   - 修改 `controller.py` 中的 `await asyncio.sleep(5.0)` 为更长时间（如8秒或10秒）

3. **深度思考模式**: 深度思考模式会让AI花更多时间思考，自然降低请求频率，但也会增加总答题时间

4. **监控日志**: 注意查看日志中的"检测到频率限制"提示，了解系统运行状态

## 技术细节

### 错误处理流程

```python
# 当AI服务返回错误时
except AIServiceError as e:
    # 检查是否是频率限制
    if "rate limited" in str(e) or "710022004" in str(e):
        # 等待10秒
        await asyncio.sleep(10.0)
    # 跳过当前题，继续下一题
```

### 豆包API响应格式

频率限制错误会以SSE事件返回：

```json
{
  "event_type": 2005,  // 错误事件
  "event_data": {
    "code": 710022004,
    "message": "rate limited"
  }
}
```

系统会捕获这个错误并转换为友好的提示信息。

## 常见问题

**Q: 为什么前面几十题都正常，突然就开始报错？**

A: 豆包的频率限制是累积的，当短时间内请求次数超过阈值时就会触发。

**Q: 等待10秒后还是报错怎么办？**

A: 可以手动暂停答题，等待1-2分钟后再继续。

**Q: 能不能完全避免频率限制？**

A: 无法完全避免，但通过增加延迟时间可以大幅降低触发概率。建议将基础延迟调整到8-10秒。

## 更新日志

- 2026-01-30: 添加频率限制检测和智能等待机制
- 2026-01-30: 将基础延迟从3秒增加到5秒
- 2026-01-30: 修复event_type 2005错误事件处理
